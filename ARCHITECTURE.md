# 文件夹上传功能架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户界面层                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         FolderUpload.vue (主组件)                         │  │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────────┐   │  │
│  │  │ 文件夹选择 │  │ 树形表格   │  │  工具栏          │   │  │
│  │  │            │  │            │  │ - 开始上传       │   │  │
│  │  │ [选择按钮] │  │ - 文件名   │  │ - 暂停上传       │   │  │
│  │  │            │  │ - 大小     │  │ - 清空列表       │   │  │
│  │  │            │  │ - 路径     │  │                  │   │  │
│  │  │            │  │ - 进度条   │  │ [统计信息]       │   │  │
│  │  │            │  │ - 状态     │  │                  │   │  │
│  │  └────────────┘  └────────────┘  └──────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         uploadService.ts (上传服务)                       │  │
│  │                                                            │  │
│  │  ┌──────────────────┐  ┌──────────────────────────────┐  │  │
│  │  │ 文件处理         │  │ 上传管理                     │  │  │
│  │  │                  │  │                              │  │  │
│  │  │ - 文件分片       │  │ - uploadFileWithChunks()     │  │  │
│  │  │ - 哈希计算       │  │ - uploadFilesWithConcurrency()│ │  │
│  │  │ - 分片创建       │  │ - uploadSingleFile()         │  │  │
│  │  │                  │  │                              │  │  │
│  │  └──────────────────┘  └──────────────────────────────┘  │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ 并发控制                                             │ │  │
│  │  │ - 队列管理                                           │ │  │
│  │  │ - 最大并发数控制（6个）                              │ │  │
│  │  │ - 任务调度                                           │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        网络通信层                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Axios                                  │  │
│  │                                                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │  │
│  │  │ HTTP 请求   │  │ 进度跟踪    │  │ 取消控制        │  │  │
│  │  │             │  │             │  │                 │  │  │
│  │  │ - POST      │  │ - onProgress│  │ - AbortSignal   │  │  │
│  │  │ - GET       │  │             │  │ - AbortController│ │  │
│  │  │             │  │             │  │                 │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    开发环境 Mock 层                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         mockUploadServer.ts (仅开发环境)                  │  │
│  │                                                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │  │
│  │  │ 请求拦截     │  │ 分片存储     │  │ 网络模拟     │   │  │
│  │  │              │  │              │  │              │   │  │
│  │  │ - /chunk     │  │ - Map存储    │  │ - 延迟模拟   │   │  │
│  │  │ - /merge     │  │ - 临时缓存   │  │ - 100-500ms  │   │  │
│  │  │ - /check     │  │              │  │              │   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        后端服务层                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         backend-example.js (生产环境)                     │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ API 端点                                             │ │  │
│  │  │                                                      │ │  │
│  │  │ POST   /api/upload/chunk    - 接收分片              │ │  │
│  │  │ POST   /api/upload/merge    - 合并分片              │ │  │
│  │  │ GET    /api/upload/check    - 检查文件状态          │ │  │
│  │  │ POST   /api/upload/single   - 单文件上传            │ │  │
│  │  │ DELETE /api/upload/cleanup  - 清理临时文件          │ │  │
│  │  │ GET    /api/upload/stats    - 获取统计信息          │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ 文件系统                                             │ │  │
│  │  │                                                      │ │  │
│  │  │ - /uploads/     (最终文件存储)                      │ │  │
│  │  │ - /temp/        (临时分片存储)                      │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流程图

### 1. 文件选择流程

```
用户点击"选择文件夹"
        │
        ▼
触发 <input webkitdirectory>
        │
        ▼
获取 FileList
        │
        ▼
buildFileTree() 构建树形结构
        │
        ├─ 解析文件路径
        ├─ 创建文件夹节点
        ├─ 创建文件节点
        └─ 建立父子关系
        │
        ▼
渲染到 el-table (树形表格)
```

### 2. 文件上传流程

```
用户点击"开始上传"
        │
        ▼
收集待上传文件
        │
        ▼
创建上传队列
        │
        ▼
启动并发上传 (最多6个)
        │
        ├─────────┬─────────┬─────────┬─────────┬─────────┐
        ▼         ▼         ▼         ▼         ▼         ▼
     文件1      文件2      文件3      文件4      文件5      文件6
        │         │         │         │         │         │
        └─────────┴─────────┴─────────┴─────────┴─────────┘
                              │
                              ▼
                    单个文件上传流程
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
  计算文件哈希          检查文件状态          创建文件分片
        │                     │                     │
        │                     ▼                     │
        │            已存在? (秒传)                 │
        │              │     │                      │
        │              是    否                     │
        │              │     │                      │
        │              │     └──────────────────────┘
        │              │                            │
        │              ▼                            ▼
        │           完成                    逐片上传分片
        │                                          │
        │                                          ├─ 分片1
        │                                          ├─ 分片2
        │                                          ├─ 分片3
        │                                          └─ ...
        │                                          │
        │                                          ▼
        │                                   更新进度 (0-99%)
        │                                          │
        └──────────────────────────────────────────┤
                                                   ▼
                                            合并所有分片
                                                   │
                                                   ▼
                                            更新进度 (100%)
                                                   │
                                                   ▼
                                              上传完成
```

### 3. 分片上传详细流程

```
uploadFileWithChunks(file)
        │
        ▼
calculateFileHash(file)
        │
        ▼
checkFileExists(hash)
        │
        ├─ 文件已存在 ──────────────────────────┐
        │                                        │
        ├─ 部分分片已上传 ─┐                    │
        │                  │                    │
        └─ 文件不存在      │                    │
                │          │                    │
                ▼          ▼                    │
        createFileChunks() │                    │
                │          │                    │
                ▼          ▼                    │
        过滤已上传分片 ────┘                    │
                │                               │
                ▼                               │
        for each chunk:                         │
                │                               │
                ├─ 检查 AbortSignal             │
                │                               │
                ├─ uploadChunk()                │
                │   │                           │
                │   ├─ FormData                 │
                │   ├─ POST /api/upload/chunk   │
                │   └─ 更新进度                 │
                │                               │
                └─ 下一个分片                   │
                │                               │
                ▼                               │
        mergeChunks()                           │
                │                               │
                ├─ POST /api/upload/merge       │
                │                               │
                └─────────────────┬─────────────┘
                                  │
                                  ▼
                            上传完成 (100%)
```

## 并发控制机制

```
上传队列: [文件1, 文件2, 文件3, 文件4, 文件5, 文件6, 文件7, 文件8]
                                  │
                                  ▼
                        启动6个并发任务
                                  │
        ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
        ▼         ▼         ▼         ▼         ▼         ▼         │
     任务1      任务2      任务3      任务4      任务5      任务6      │
        │         │         │         │         │         │         │
        ▼         │         │         │         │         │         │
     完成 ────────┘         │         │         │         │         │
        │                   │         │         │         │         │
        ▼                   │         │         │         │         │
   取出文件7 ───────────────┘         │         │         │         │
        │                             │         │         │         │
        ▼                             │         │         │         │
     上传中                           │         │         │         │
        │                             ▼         │         │         │
        │                          完成 ────────┘         │         │
        │                             │                   │         │
        │                             ▼                   │         │
        │                        取出文件8 ───────────────┘         │
        │                             │                             │
        └─────────────────────────────┴─────────────────────────────┘
                                      │
                                      ▼
                              所有文件上传完成
```

## 状态管理

```
文件状态机:

    pending (待上传)
        │
        ▼
    uploading (上传中)
        │
        ├─────────┬─────────┬─────────┐
        │         │         │         │
        ▼         ▼         ▼         ▼
    success   exception   paused   uploading
    (完成)     (失败)     (暂停)   (继续上传)
                │         │
                │         └──────> uploading
                │                     │
                └──────> uploading    │
                            │         │
                            └─────────┘
```

## 组件通信

```
FolderUpload.vue
    │
    ├─ Props: 无
    │
    ├─ Emits: 无
    │
    ├─ 内部状态:
    │   ├─ fileList (文件树)
    │   ├─ isUploading (上传状态)
    │   ├─ uploadQueue (上传队列)
    │   ├─ activeUploads (活跃上传)
    │   └─ uploadControllers (取消控制器)
    │
    └─ 调用服务:
        └─ uploadService.uploadFileWithChunks()
            │
            ├─ 参数:
            │   ├─ file: File
            │   ├─ chunkSize: number
            │   ├─ onProgress: (progress) => void
            │   ├─ signal: AbortSignal
            │   └─ metadata: object
            │
            └─ 返回: Promise<void>
```

## 错误处理流程

```
上传过程中
    │
    ├─ 网络错误
    │   └─> 标记为 exception
    │       └─> 可重新上传
    │
    ├─ 用户取消 (AbortSignal)
    │   └─> 标记为 paused
    │       └─> 可继续上传
    │
    ├─ 服务器错误 (500)
    │   └─> 标记为 exception
    │       └─> 可重新上传
    │
    └─ 超时错误
        └─> 标记为 exception
            └─> 可重新上传
```

## 性能优化点

### 1. 内存优化

- 使用 `Blob.slice()` 分片，不加载整个文件到内存
- 逐片上传，及时释放内存
- 限制并发数，避免内存溢出

### 2. 网络优化

- 分片上传，支持断点续传
- 并发上传，提高上传速度
- 检查已上传分片，避免重复上传

### 3. 用户体验优化

- 实时进度显示
- 状态可视化
- 支持暂停/继续
- 错误提示

## 扩展性设计

### 1. 可配置参数

- 分片大小
- 并发数
- 超时时间
- API 地址

### 2. 可扩展功能

- 自定义哈希算法
- 自定义上传逻辑
- 自定义进度显示
- 自定义错误处理

### 3. 可集成性

- 独立组件，易于集成
- 服务层分离，可单独使用
- Mock 层可选，方便开发测试
